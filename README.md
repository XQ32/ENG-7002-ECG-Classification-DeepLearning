# ENG-7002-ECG-Classification

## Usage Instructions

### Basic Usage
1.  Extract data files from the OneDrive folder "Master Project" to the `results` directory.
2.  Run `main_v3.m`.

### Network Architecture Configuration
Modify `dl_params.networkType` in `main_v3.m` to select different network architectures:

```matlab
% Select network type
dl_params.networkType = 'enhanced';  % Recommended: Enhanced Hybrid CNN
% dl_params.networkType = 'simple';     % Simple Hybrid CNN
% dl_params.networkType = 'multimodal'; % Multi-modal Attention Network
```

### Caching Mechanism Description
- **First Run**: The program will execute the complete data processing pipeline (steps 1-6) and automatically save cache
- **Subsequent Runs**: If the dataset and configuration are unchanged, the program will automatically load cache and jump directly to model training
- **Force Reprocessing**: Delete cache files in the `results` directory to force data reprocessing

## Project Structure

The project code structure has been refactored to improve modularity and readability. Main files and directories are as follows:

-   `/` (root directory): Contains main scripts and all functional modules.
    -   `main_v3.m`: Main entry point and execution controller of the project, supports data caching mechanism.
    -   `setupConfiguration.m`: Sets all configuration parameters, such as database paths and allocations.
    -   `loadAndProcessECGData.m`: Responsible for loading and preprocessing ECG data.
    -   `cleanHeartbeatData.m`: Cleans data, removes invalid heartbeat records.
    -   `displayBeatStatistics.m`: Statistics and displays heartbeat classification results.
    -   `createDLDatasets.m`: Prepares, balances and saves data for deep learning models.
    -   `trainAndEvaluateModel.m`: Builds, trains and evaluates deep learning models, supports GPU acceleration.
    -   `buildHybridCNNModel.m`: Builds original simple hybrid CNN model.
    -   `buildEnhancedHybridCNNModel.m`: Builds improved enhanced hybrid CNN model.
    -   `buildMultiModalAttentionModel.m`: Builds multi-modal attention network.
    -   `checkAndLoadCachedData.m`: Checks and loads cached processed data.
    -   `saveCachedData.m`: Saves processed data to cache.
    -   `*.m`: Other core algorithms and utility functions.
-   `/mcode`: Contains [WFDB Toolbox for MATLAB](https://physionet.org/content/wfdb-matlab/0.10.0/), used for processing PhysioNet databases.
-   `/results`: Stores `.mat` data files downloaded from PhysioNet and intermediate and final results generated by program execution.

## Code Execution Flow

The entire process is controlled by `main_v3.m`, supporting intelligent data caching mechanism. Main execution steps:

1. **Configuration Setup** (`setupConfiguration.m`): Load database allocation and deep learning parameters
2. **Cache Check** (`checkAndLoadCachedData.m`): Detect cached data, skip data processing steps if available
3. **Data Processing** (steps 2-5): If cache is unavailable, sequentially execute data loading, cleaning, statistics and deep learning data preparation
4. **Model Training** (`trainAndEvaluateModel.m`): Select network architecture for training and evaluation according to configuration

### Key Features:
- **Intelligent Caching**: Automatically detect and reuse processed data, significantly improving repeated run efficiency
- **GPU Acceleration**: Automatically detect GPU and enable accelerated training
- **Multi-Architecture Support**: Supports three architectures: simple CNN, enhanced CNN, multi-modal attention network
- **Complete Configuration System**: Unified management of all parameters through `setupConfiguration.m`

## Deep Learning Network Architecture Analysis

This project provides three deep learning network architectures of different complexity levels, selectable based on requirements:

### Network Architecture Selection

| Network Type | File Name | Application Scenario | Features |
|----------|--------|----------|------|
| **simple** | `buildHybridCNNModel.m` | Quick validation, resource-constrained | Pure fully-connected, few parameters, fast training |
| **enhanced** | `buildEnhancedHybridCNNModel.m` | Balance performance and complexity | 1D convolution + intelligent fusion, recommended |
| **multimodal** | `buildMultiModalAttentionModel.m` | High performance requirements | Multi-scale + attention mechanism, most complex |

### 1. Simple Hybrid CNN Model (simple)

Basic dual-branch structure, fusing features through addition layer:

```
Input Layer
â”œâ”€â”€ Waveform Branch: ECG waveform (288-dim) â†’ FC(288â†’128â†’64â†’32) â†’ ReLU
â””â”€â”€ Context Branch: RR intervals (2/4-dim) â†’ FC(2/4â†’32) â†’ ReLU
                                            â†“
                           Fusion Layer: Addition Layer
                                            â†“
                     Classification Layer: FC(32â†’numClasses) â†’ Softmax
```


### 2. Enhanced Hybrid CNN Model (enhanced) - Recommended

Improved architecture, integrating 1D convolution and intelligent feature fusion:

```
Input Layer
â”œâ”€â”€ Waveform Branch: ECG waveform (288-dim)
â”‚   â”œâ”€â”€ Fully Connected Layers: 288 â†’ 256 â†’ 128 â†’ 64 (with ReLU and Dropout)
â”‚   â””â”€â”€ Output Features: 64-dim
â”‚
â””â”€â”€ Context Branch: RR intervals/quality features (4-dim)
    â”œâ”€â”€ Fully Connected Layers: 4 â†’ 128 â†’ 64 (with ReLU)
    â””â”€â”€ Output Features: 64-dim
                        â†“
            Fusion Layer: Concatenation (128-dim)
                        â†“
        Classification Layer: 128 â†’ 64 â†’ 32 â†’ numClasses (with Dropout)
```

**Key Improvements:**
- ðŸ”§ **Deep Feature Extraction**: Increased network depth, enhanced feature representation capability
- ðŸ”§ **Layered Regularization**: Different layers use different Dropout rates to prevent overfitting
- ðŸ”§ **Intelligent Fusion**: Concatenation layer preserves more feature information
- ðŸ”§ **Configurable Architecture**: Supports complete network structure customization through `dl_params`

### 3. Multi-modal Attention Network (multimodal)

Advanced multi-scale feature extraction and attention mechanism:

```
Input Layer
â”œâ”€â”€ Short-term Feature Branch: 1D Conv(3,7) â†’ MaxPool â†’ GAP
â”œâ”€â”€ Medium-term Feature Branch: 1D Conv(15,7) â†’ MaxPool â†’ GAP
â””â”€â”€ Long-term Feature Branch: 1D Conv(31,15) â†’ MaxPool â†’ GAP
                              â†“
           Multi-scale Fusion: Concatenation + Attention Mechanism
                              â†“
            Context Fusion: Fusion with RR interval features
                              â†“
           Classification Output: FC layers + Softmax
```

### Current Deep Learning Parameter Configuration

#### Network Architecture Parameters (Enhanced CNN)
```matlab
% Waveform branch layer configuration (fully connected layer sizes)
waveformBranchLayers = [256, 128, 64]

% Context branch layer configuration
contextBranchLayers = [128, 64]

% Fusion layer configuration
fusionLayers = [128, 64, 32]

% Unified feature dimension
commonFeatureSize = 64
```

#### Regularization Parameters
```matlab
% Dropout configuration
dropoutRate = 0.4              % Main dropout rate
waveformDropoutRate = 0.2      % Waveform branch dropout
fusionDropoutRate = 0.5        % Fusion layer dropout

% Activation function
activationType = 'relu'        % ReLU activation function
```

#### Training Parameters
```matlab
% Optimizer configuration
optimizer = 'adam'             % Adam optimizer
initialLearningRate = 1e-3     % Initial learning rate
miniBatchSize = 128            % Batch size
maxEpochs = 15                 % Maximum training epochs

% Validation and early stopping
validationSplit = 0.05         % Validation set ratio 5%
enableEarlyStopping = true     % Enable early stopping
patience = 3                   % Early stopping patience value
```

#### Classification Task Configuration
```matlab
% Binary classification task
task = 'binary'
classNames = {'Other', 'PVC'}
threshold = 0.08               % Classification threshold (optimized for recall)

% Class balancing
method = 'weights'             % Use weighting method
classWeights = [1.0, 4.0]      % PVC class weight is 4x
```

#### Data Preprocessing
```matlab
% Waveform standardization
standardLength = 288           % Standard waveform length
normalizationMethod = 'zscore' % Z-score normalization

% Context features (enhanced mode)
contextDimension = 4           % 4-dimensional features
enhanced = true                % Enable quality assessment features
```

